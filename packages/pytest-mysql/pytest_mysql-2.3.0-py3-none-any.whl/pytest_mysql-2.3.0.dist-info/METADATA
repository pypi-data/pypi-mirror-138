Metadata-Version: 2.1
Name: pytest-mysql
Version: 2.3.0
Summary: MySQL process and client fixtures for pytest
Home-page: https://github.com/ClearcodeHQ/pytest-mysql
Maintainer: Grzegorz Śliwiński
Maintainer-email: fizyk+pypi@fizyk.net.pl
License: LGPLv3+
Keywords: tests,py.test,pytest,fixture,mysql
Platform: UNKNOWN
Classifier: Development Status :: 5 - Production/Stable
Classifier: Environment :: Web Environment
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: GNU Lesser General Public License v3 or later (LGPLv3+)
Classifier: Natural Language :: English
Classifier: Operating System :: OS Independent
Classifier: Programming Language :: Python
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.7
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3 :: Only
Classifier: Topic :: Software Development :: Libraries :: Python Modules
Classifier: Topic :: Software Development :: Testing
Classifier: Framework :: Pytest
Requires-Python: >=3.7
Description-Content-Type: text/x-rst
License-File: COPYING
License-File: COPYING.lesser
License-File: AUTHORS.rst
Requires-Dist: pytest (>=6.2)
Requires-Dist: port-for (>=0.6.0)
Requires-Dist: mirakuru
Requires-Dist: mysqlclient
Provides-Extra: tests
Requires-Dist: pytest-cov ; extra == 'tests'
Requires-Dist: pytest-xdist ; extra == 'tests'
Requires-Dist: mock ; extra == 'tests'

.. image:: https://raw.githubusercontent.com/ClearcodeHQ/pytest-mysql/master/logo.png
    :width: 100px
    :height: 100px
    
pytest-mysql
============

.. image:: https://img.shields.io/pypi/v/pytest-mysql.svg
    :target: https://pypi.python.org/pypi/pytest-mysql/
    :alt: Latest PyPI version

.. image:: https://img.shields.io/pypi/wheel/pytest-mysql.svg
    :target: https://pypi.python.org/pypi/pytest-mysql/
    :alt: Wheel Status

.. image:: https://img.shields.io/pypi/pyversions/pytest-mysql.svg
    :target: https://pypi.python.org/pypi/pytest-mysql/
    :alt: Supported Python Versions

.. image:: https://img.shields.io/pypi/l/pytest-mysql.svg
    :target: https://pypi.python.org/pypi/pytest-mysql/
    :alt: License

What is this?
=============

This is a pytest plugin, that enables you to test your code that relies on a running MySQL Database.
It allows you to specify fixtures for MySQL process and client.

.. warning::

    Only MySQL 5.7.6 and up are supported. For older versions, please use pytest-mysql 2.0.3
    Although Pull Request to add back support for older MySQL versions are welcome.

How to use
==========

Plugin contains two fixtures

* **mysql** - it's a client fixture that has functional scope. After each test drops test database from MySQL ensuring repeatability.
* **mysql_proc** - session scoped fixture, that starts MySQL instance at it's first use and stops at the end of the tests.
* **mysql_noproc** - session scoped fixtures, that allows to connect to already existing MySQL instance, and cleans the database at the end of the tests

Simply include one of these fixtures into your tests fixture list.

You can also create additional mysql client and process fixtures if you'd need to:


.. code-block:: python

    from pytest_mysql import factories
    from getpass import getuser()

    mysql_my_proc = factories.mysql_proc(
        port=None, user=getuser())
    mysql_my = factories.mysql('mysql_my_proc')

.. note::

    Each MySQL process fixture can be configured in a different way than the others through the fixture factory arguments.

Configuration
=============

You can define your settings in three ways, it's fixture factory argument, command line option and pytest.ini configuration option.
You can pick which you prefer, but remember that these settings are handled in the following order:

    * ``Fixture factory argument``
    * ``Command line option``
    * ``Configuration option in your pytest.ini file``

.. list-table:: Configuration options
   :header-rows: 1

   * - MySQL/MariaDB option
     - Fixture factory argument
     - Command line option
     - pytest.ini option
     - Noop process fixture
     - Default
   * - Path to executable
     - mysqld_exec
     - --mysql-mysqld
     - mysql_mysqld
     - -
     - mysqld
   * - Path to safe executable
     - mysqld_safe
     - --mysql-mysqld-safe
     - mysql_mysqld_safe
     - -
     - mysqld_safe
   * - Path to mysql_install_db for legacy installations
     - install_db
     - --mysql-install-db
     - mysql_install_db
     - -
     - mysql_install_db
   * - Path to Admin executable
     - admin_executable
     - --mysql-admin
     - mysql_admin
     - -
     - mysqladmin
   * - Database hostname
     - host
     - --mysql-host
     - mysql_host
     - yes
     - localhost
   * - Database port
     - port
     - --mysql-port
     - mysql_port
     - yes (3306)
     - random
   * - MySQL user to work with
     - user
     - --mysql-user
     - mysql_user
     - -
     - root
   * - User's password
     - passwd
     - --mysql-passwd
     - mysql_passwd
     - -
     -
   * - Test database name
     - dbname
     - --mysql-dbname
     - mysqldbname
     - -
     - test
   * - Starting parameters
     - params
     - --mysql-params
     - mysql_params
     - -
     -
   * - Log directory location [DEPRECATED]
     - logsdir
     - --mysql-logsdir
     - mysql_logsdir
     - -
     - $TMPDIR


Example usage:

* pass it as an argument in your own fixture

    .. code-block:: python

        mysql_proc = factories.mysql_proc(
            port=8888)

* use ``--mysql-port`` command line option when you run your tests

    .. code-block::

        py.test tests --mysql-port=8888


* specify your port as ``mysql_port`` in your ``pytest.ini`` file.

    To do so, put a line like the following under the ``[pytest]`` section of your ``pytest.ini``:

    .. code-block:: ini

        [pytest]
        mysql_port = 8888

Examples
========

Populating database for tests
-----------------------------

With SQLAlchemy
+++++++++++++++

This example shows how to populate database and create an SQLAlchemy's ORM connection:

Sample below is simplified session fixture from
`pyramid_fullauth <https://github.com/fizyk/pyramid_fullauth/>`_ tests:

.. code-block:: python

    from sqlalchemy import create_engine
    from sqlalchemy.orm import scoped_session, sessionmaker
    from sqlalchemy.pool import NullPool
    from zope.sqlalchemy import register


    @pytest.fixture
    def db_session(mysql):
        """Session for SQLAlchemy."""
        from pyramid_fullauth.models import Base  # pylint:disable=import-outside-toplevel

        # assumes setting, these can be obtained from pytest-mysql config or mysql_proc
        connection = f'mysql+mysqldb://root:@127.0.0.1:3307/tests?charset=utf8'

        engine = create_engine(connection, echo=False, poolclass=NullPool)
        pyramid_basemodel.Session = scoped_session(sessionmaker(extension=ZopeTransactionExtension()))
        pyramid_basemodel.bind_engine(
            engine, pyramid_basemodel.Session, should_create=True, should_drop=True)

        yield pyramid_basemodel.Session

        transaction.commit()
        Base.metadata.drop_all(engine)


    @pytest.fixture
    def user(db_session):
        """Test user fixture."""
        from pyramid_fullauth.models import User
        from tests.tools import DEFAULT_USER

        new_user = User(**DEFAULT_USER)
        db_session.add(new_user)
        transaction.commit()
        return new_user


    def test_remove_last_admin(db_session, user):
        """
        Sample test checks internal login, but shows usage in tests with SQLAlchemy
        """
        user = db_session.merge(user)
        user.is_admin = True
        transaction.commit()
        user = db_session.merge(user)

        with pytest.raises(AttributeError):
            user.is_admin = False
.. note::

    See the original code at `pyramid_fullauth's conftest file <https://github.com/fizyk/pyramid_fullauth/blob/2950e7f4a397b313aaf306d6d1a763ab7d8abf2b/tests/conftest.py#L35>`_.
    Depending on your needs, that in between code can fire alembic migrations in case of sqlalchemy stack or any other code

Connecting to MySQL/MariaDB (in a docker)
-----------------------------------------

To connect to a docker run postgresql and run test on it, use noproc fixtures.

.. code-block:: sh

    docker run --name some-db -e MYSQL_ALLOW_EMPTY_PASSWORD=yes -d mysql --expose 3306

.. code-block:: sh

    docker run --name some-db -e MARIADB_ALLOW_EMPTY_PASSWORD=yes -d mariadb --expose 3306

This will start postgresql in a docker container, however using a postgresql installed locally is not much different.

In tests, make sure that all your tests are using **mysql_noproc** fixture like that:

.. code-block:: python

    mysql_in_docker = factories.mysql_noproc()
    mysql = factories.mysql("mysql_in_docker")


    def test_mysql_docker(mysql):
        """Run test."""
        cur = mysql.cursor()
        cur.query("CREATE TABLE pet (name VARCHAR(20), owner VARCHAR(20), species VARCHAR(20), sex CHAR(1), birth DATE, death DATE);")
        mysql.commit()
        cur.close()

And run tests:

.. code-block:: sh

    pytest --mysql-host=127.0.0.1



Running on Docker/as root
=========================

Unfortunately, running MySQL as root (thus by default on docker) is not possible.
MySQL (and MariaDB as well) will not allow it.

.. code-block::

    USER nobody

This line should switch your docker process to run on user nobody. See `this comment for example <https://github.com/ClearcodeHQ/pytest-mysql/issues/62#issuecomment-367975723>`_

Package resources
-----------------

* Bug tracker: https://github.com/ClearcodeHQ/pytest-mysql/issues

CHANGELOG
=========

2.3.0
----------

Features
++++++++

- Import FixtureRequest from pytest, not private _pytest.
  Require at least pytest 6.2
- Replace tmpdir_factory with tmp_path_factory

Docs
++++

- List mysql_noproc in README's fixtures list

Fixes
+++++

- Database cleanup code will attempt to reconnect to mysql if test accidentally would close the connection

2.2.0
----------

Feature
+++++++

- add `user` option to setup and tear down mysql process as non-privileged

Misc
++++

- Add Python 3.10 to CI

2.1.0
----------

Feature
+++++++

- `mysql_noproc` fixture to connect to already running mysql server
- raise more meaningful error when the test database already exists

Misc
++++

- rely on `get_port` functionality delivered by `port_for`


Deprecation
+++++++++++

- Deprecated `mysql_logsdir` ini configuration and `--mysql-logsdir` command option
- Deprecated `logs_prefix` process fixture factory setting

Misc
++++

- Require minimum python 3.7
- Migrate CI to Github Actions

2.0.3
-------

- [enhancement] Do not assume that mysql executables are in /usr/bin

2.0.2
-------

- [enhancement] Preemptively read data after each test in mysql client fixture.
  This will make test run if the test itself forgot to fetch queried data.
- [enhnacement] Require at least mirakuru 2.3.0 - forced by changed stop method parameters change

2.0.1
-------

- [fix] Improved mysql version detection on osx
- [build] extracted xdist into separate stage on travis
- [build] have deployemt as separate stage on travis

2.0.0
-------

- [Enhancements] Add support for MySQL 5.7.6 and up with new configuration options. Legacy configuration supports older MySQL and MariaDB databases.
- [breaking] mysql_exec ini option replaced with mysql_mysqld_safe
- [breaking] --mysql-exec cmd option replaced with --mysql-mysqld-safe
- [breaking] replaced mysql_init ini option with mysql_install_db
- [breaking] replaced --mysql-init cmd option with --mysql-install-db 
- [breaking] added mysql_mysqld option and --mysql-mysqld cmd option

1.1.1
-------

- [enhancements] removed path.py dependency

1.1.0
-------

- [enhancement] change deprecated getfuncargvalaue to getfixturevalues, require at least pytest 3.0.0

1.0.0
-------

- [enhancements] create command line and pytest.ini configuration options for mysql's log directory location
- [enhancements] create command line and pytest.ini configuration options for mysql's starting parametetrs
- [enhancements] create command line and pytest.ini configuration options for mysql test database name
- [enhancements] create command line and pytest.ini configuration options for mysql's user password
- [enhancements] create command line and pytest.ini configuration options for mysql user
- [enhancements] create command line and pytest.ini configuration options for mysql host
- [enhancements] create command line and pytest.ini configuration options for mysql port
- [enhancements] create command line and pytest.ini configuration options for mysql's init executable
- [enhancements] create command line and pytest.ini configuration options for mysql's admin executable
- [enhancements] create command line and pytest.ini configuration options for mysql executable
- [enhancements] create command line and pytest.ini configuration options for mysql logsdir


