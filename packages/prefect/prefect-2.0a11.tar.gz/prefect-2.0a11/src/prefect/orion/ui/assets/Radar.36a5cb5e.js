import{_ as _e,A as je,E as Be}from"./index.5b9a0170.js";import{h as me,i as g,z as G,l as Ee,aC as he,m as ee,H as Ge,aA as Ve,r as fe,o as V,c as te,d as j,F as ye,v as De,x as xe,y as L,n as Oe,X as we,L as We,s as He,E as Ke,a as D,p as Pe,b as Ue,a3 as B,aD as ce,aB as Xe,az as Ye,P as Je}from"./vendor.3aa9d18a.js";import{R as Qe,M as Ze,p as P,c as et,s as tt,a as at,b as ke}from"./MiniRadar.a62dca04.js";const st=M=>(Pe("data-v-9e01452a"),M=M(),Ue(),M),rt=st(()=>j("svg",{class:"radar__canvas"},[j("g",{class:"radar__edge-container"}),j("g",{class:"radar__ring-container"})],-1)),nt={class:"radar__node-container"},ot={class:"radar__minimap-controls-container"},it={class:"mb-1 d-flex align-center justify-end"},ct={class:"radar__minimap-container"},lt=me({props:{items:{type:Array,required:!0},id:{type:String,required:!0}},setup(M){const w=M,k=g(w.items),h=g(),T=g(),O=g(),F=g(),ae=g(),U=G(()=>{const t=[...N.value.entries()];return new Map([...u.value.nodes.entries()].filter(([,s])=>t.every(([,i])=>!i.get(s.id))).filter(([,s])=>{var a;if(!u.value.rings.get(s.ring))return;const r=s.position;if(!r)return;const n=[...r.nodes.values()];return((a=n==null?void 0:n[0])==null?void 0:a.id)==s.id}))}),$e=G(()=>{const t=new Set([...U.value.entries()].map(([,s])=>s.ring));return new Map([...u.value.rings.entries()].filter(([s])=>t.has(s)))}),se=G(()=>{const t=[...N.value.entries()];return u.value.links.filter(s=>t.every(([,i])=>!i.get(s.target.id))).filter(s=>U.value.get(s.source.id)&&U.value.get(s.target.id))}),be=({transform:t})=>{var i,r,n;const s=`translate(${t.x}px, ${t.y}px) scale(${t.k})`;(i=F.value)==null||i.style("transform",s),(r=O.value)==null||r.style("transform",s),(n=ae.value)==null||n.style("transform",s),de.value=t},ze=t=>{u.value.expandRing(t.ring)},Re=t=>{if(N.value.get(t.id))N.value.delete(t.id);else{const s=u.value.traverse(t);N.value.set(t.id,s)}},Ae=()=>{var i;const t=(r,n,a,v)=>{const _=v*(P/180),e=r+a*et(_)||0,l=n+a*tt(_)||0;return[e,l]},s=([,r],n=1)=>{const a=r.radius,_=125*360/(2*P*a),e=b.value/2*n,l=$.value/2*n,[o,m]=t(e,l,a,90-_),[z,W]=t(e,l,a,90+_);return`M ${o} ${m} A${r.radius} ${r.radius} 0 1 0 ${z} ${W}`};(i=F.value)==null||i.selectAll(".radar__ring").data($e.value).join(r=>{const n=r.append("g");return n.attr("id",v=>v.id),n.attr("class","radar__ring").append("path").attr("id",([v])=>v).attr("d",v=>s(v,1)).style("opacity",1).attr("fill","transparent").attr("stroke","rgba(0, 0, 0, 0.03)").attr("stroke-width",80),n},r=>(r.select("path").attr("id",([a])=>a).attr("d",a=>s(a,1)),r),r=>r.remove())},X=()=>{var _;const t=(e,l,o,m,z)=>{const W=at(ke(o-e,2)+ke(m-l,2)),c=z/W,R=(1-c)*e+c*o,A=(1-c)*l+c*m;return[R,A]},s=(e,l)=>{const o=Ye(),m=P/2,z=3*P/2,W=0,c=u.value.rings.get(e.source.ring),R=u.value.rings.get(e.target.ring),A=u.value.rings.get(e.target.ring-1),ve=u.value.rings.get(e.source.ring+1),ge=c.links,Ne=ge.findIndex(p=>p.source.id==e.source.id&&p.target.id==e.target.id),y=b.value/2,C=$.value/2,ie=(R.radius-c.radius)/2,Se=ie/ge.length,pe=Ne*Se,Y=e.target.cx,J=e.target.cy,q=e.target.radian,Q=e.source.cx,Z=e.source.cy,I=e.source.radian;let H,K;if(c.radius==0){const[p,x]=t(y,C,Y,J,R.radius-c.radius);H=p,K=x}else if(e.target.ring-e.source.ring==1){const[p,x]=t(y,C,Q,Z,c.radius+ie*1.25-pe);H=p,K=x}else{const[p,x]=t(y,C,Q,Z,c.radius+(ve.radius-c.radius)/2);H=p,K=x}if(o.moveTo(Q,Z),e.target.ring-e.source.ring>1){c.radius!==0&&(o.lineTo(H,K),o.arc(y,C,c.radius+(ve.radius-c.radius)/2,I,m,I<z&&I>W));const p=A.radius+(R.radius-A.radius)/2,[x,E]=t(y,C,y,p,A.radius+(R.radius-A.radius)/2);o.lineTo(x,E),o.arc(y,C,A.radius+(R.radius-A.radius)/2,m,q,q>z||q<m)}else{o.lineTo(H,K);const[p,x]=t(y,C,Y,J,R.radius-c.radius);if(Y!==Q&&J!==Z&&c.radius!==0){const E=P/2;o.arc(y,C,c.radius+ie*1.25-pe,I,q,I>E&&q>E&&q<I||I<E&&(q>E||q<I))}else o.moveTo(p,x)}return o.lineTo(Y,J),o.toString()},i=e=>{const l=u.value.rings.get(e.source.ring),o=u.value.rings.get(e.target.ring),m=l.links,z=(o.radius-l.radius)/m.length;return Math.min(5,z)},r=e=>{const l=d.includes(e.source.id)||d.includes(e.target.id),o=f.value&&(e.source.id==f.value||e.target.id==f.value);return l||o},n=e=>!f.value&&d.length===0||r(e)?1:.2,a=e=>e.source.id+"---"+e.target.id,v=e=>{const l=["radar__edge"];return(r(e)||d.length==0&&!f.value)&&l.push(`${e.source.data.state.type.toLowerCase()}-stroke`),se.value.length<100&&l.push("radar__edge--transition"),l.join(" ")};(_=O.value)==null||_.selectAll(".radar__edge").data(se.value).join(e=>e.append("path").attr("id",a).attr("class",v).style("stroke-width",i).attr("d",s).style("opacity",n),e=>e.attr("id",a).attr("class",v).style("stroke-width",i).attr("d",s).style("opacity",n),e=>e.remove())},re=()=>{Ae(),X()},le=t=>{f.value==t?f.value=void 0:f.value=t,requestAnimationFrame(()=>X())},ue=t=>{const s=d.indexOf(t);s>-1?d.splice(s,1):d.push(t)},Ce=t=>{requestAnimationFrame(()=>{B(".radar__canvas").transition().duration(200).call(S.value.transform,t)})},qe=({x:t,y:s})=>{S.value.translateBy(B(".radar__canvas"),t,s)},Ie=()=>{d.length=0},ne=()=>{B(".radar__canvas").transition().ease(ce).duration(250).call(S.value.transform,Xe)},Le=()=>{requestAnimationFrame(()=>{S.value.scaleBy(B(".radar__canvas").transition().ease(ce).duration(250),1.35)})},Me=()=>{requestAnimationFrame(()=>{S.value.scaleBy(B(".radar__canvas").transition().ease(ce).duration(250),.65)})},$=g(0),b=g(0),f=g(),d=Ee([]),de=g({x:0,y:0,k:1}),N=g(new Map),u=g(new Qe),S=g(he());ee(()=>[w.items,w.id],(t,s)=>{const[i,r]=t,[n,a]=s;k.value=w.items,u.value.items(k.value),(i.length>0&&n.length==0||r!==a)&&(u.value.center([b.value/2,$.value/2]),d.length=0,ne()),i.length!==n.length||r!==a?requestAnimationFrame(()=>re()):requestAnimationFrame(()=>X())}),ee(d,()=>{requestAnimationFrame(()=>X())}),ee(se,()=>{requestAnimationFrame(()=>re())});const oe=()=>{!h.value||($.value=h.value.offsetHeight,b.value=h.value.offsetWidth)},Te=()=>{var t;T.value=B(".radar__canvas"),F.value=T.value.select(".radar__ring-container"),O.value=T.value.select(".radar__edge-container"),ae.value=B(".radar__node-container"),S.value=he().extent([[0,0],[b.value,$.value]]).on("zoom",be),(t=T.value)==null||t.attr("viewbox",`0, 0, ${b.value}, ${$.value}`).call(S.value),re(),ne()},Fe=t=>{t.preventDefault(),!!h.value&&(h.value.scrollTop=0,h.value.scrollLeft=0)};return Ge(()=>{oe(),window.addEventListener("resize",oe),u.value.id("id").dependencies("upstream_dependencies").center([b.value/2,$.value/2]).items(k.value),Te()}),Ve(()=>{window.removeEventListener("resize",oe)}),(t,s)=>{const i=fe("radar-overflow-node"),r=fe("icon-button");return V(),te("div",{ref:(n,a)=>{a.container=n,h.value=n},class:"radar",onScroll:Fe},[rt,j("div",nt,[(V(!0),te(ye,null,De(L(U),([n,a])=>{var v,_;return V(),te(ye,{key:n},[((v=a.position)==null?void 0:v.nodes.size)==1?(V(),xe(Ke(a.data.state.state_details.child_flow_run_id?"radar-flow-run-node":"radar-node"),{key:0,id:`node-${n}`,node:a,selected:L(d).includes(a.id),class:Oe(["radar__node position-absolute",{"radar__node--transparent":L(d).length>0&&!L(d).includes(a.id)&&f.value!==a.id,"radar__node--deemphasized":L(d).length>0&&L(d).some(e=>a.upstreamNodes.get(e)||a.downstreamNodes.get(e))}]),collapsed:N.value.get(n),style:we({left:a.cx+"px",top:a.cy+"px"}),tabindex:"0",onToggleTree:Re,onClick:We(e=>ue(a.id),["stop"]),onKeyup:He(e=>ue(a.id),["space","enter"]),onMouseover:e=>le(a.id),onMouseout:e=>le(a.id)},null,8,["id","node","selected","class","collapsed","style","onClick","onKeyup","onMouseover","onMouseout"])):(V(),xe(i,{key:1,class:"position-absolute",nodes:(_=a.position)==null?void 0:_.nodes,style:we({left:a.cx+"px",top:a.cy+"px"}),tabindex:"0",onClick:e=>ze(a)},null,8,["nodes","style","onClick"]))],64)}),128))]),j("div",ot,[j("div",it,[D(r,{class:"bg--white justify-self-start mr-auto",icon:"pi-restart-line",onClick:Ie}),D(r,{class:"bg--white mr-1",icon:"pi-zoom-in-line",onClick:Le}),D(r,{class:"bg--white mr-1",icon:"pi-zoom-out-line",onClick:Me}),D(r,{class:"bg--white",icon:"pi-fullscreen-fill",onClick:ne})]),j("div",ct,[D(Ze,{class:"radar__minimap position-relative",id:M.id,transform:de.value,"collapsed-trees":N.value,radar:u.value,height:$.value,width:b.value,onDragViewport:qe,onPanToLocation:Ce},null,8,["id","transform","collapsed-trees","radar","height","width"])])])],544)}}});var ut=_e(lt,[["__scopeId","data-v-9e01452a"]]);const dt={class:"radar z-0"},vt=me({setup(M){const w=Je(),k=G(()=>w==null?void 0:w.params.id),h=G(()=>({id:k.value})),T={radar:je.query({endpoint:Be.radar,body:h,options:{pollInterval:5e3}})},O=G(()=>{var F;return((F=T.radar.response)==null?void 0:F.value)||[]});return ee(k,()=>{!k.value||T.radar.fetch()}),(F,ae)=>(V(),te("div",dt,[D(ut,{id:L(k),items:L(O)},null,8,["id","items"])]))}});var mt=_e(vt,[["__scopeId","data-v-18cdbfba"]]);export{mt as default};
